<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>


<script type="module">
  const TestSubmitApp = {
    delimiters: ['[[', ']]'],
    data() {
      return {
        csrfToken: document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        StudentId: 0,
        StudentName: "",
        ExamYearSemester: 0,
        ExamGrade: 0,
        ExamResults: [],
        AnswerList: [],
        MathAbility: [],
        Score: 0,
        selectedTerritory_low: 0,
        selectedTerritory_high: 0,
        otherTerritories_low: [],
        otherTerritories_high: [],
        OX_list: [],
        HighSchoolPredictGrade: [],
        SuneungPredictGrade:0,
        NationalPredictRatio: 0,
        StrongPoint: [],
        WeakPoint: [],
        StudentRegion: "",
        OfficeRegion: [],
        radarChartData: {
          labels: ['계산력', '이해력', '문제해결력', '추론력'],
          datasets: [
            {
              label: '능력치',
              data: [], // 초기 값
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1
            }
          ]
        },
        horizonBarChartData: {
          labels: ['백분위 최소', '백분위 최대'],
          datasets: [
            {
              label: '예상 백분위',
              data: [],
              backgroundColor: [
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)',
              ],
              borderColor: [ // 각 막대의 테두리 색
                'rgba(255, 206, 86, 1)',
                'rgba(75, 192, 192, 1)',
              ],
              borderWidth: 1
            }],          
        },
        radarChartInstance: null, // 차트 인스턴스를 저장할 속성
        horizontalBarChartInstance: null, // 차트 인스턴스를 저장할 속성
        AnswerList1: [],
        AnswerList2: [],
        ExamResults1: [],
        ExamResults2: [],
        carouselPage: 1,
        rangeNumbers: this.range(15, 25),
      };
    },
    created() {
      console.log("created()...");
      let path = location.pathname;
      if (!path.endsWith('/')) {
        path += '/';
      }
      this.StudentId = path.split('/').slice(-2)[0];

      const queryString = location.search;
      const params = new URLSearchParams(queryString);
      
      this.ExamYearSemester = params.get('year_semester');
      this.ExamGrade = params.get('test_grade');
      this.fetchReportDetail(this.StudentId);
      console.log("Initial carousel page:", this.carouselPage);

    },
    watch: {
      carouselPage(newVal) {
        if (newVal === 1) {
          this.renderRadarChart();
        }
      }
    },
    methods: {
      fetchReportDetail(StudentId) {
        console.log("fetchReportDetail()...", StudentId);
        axios.get(`/api/report/detail/${StudentId}?year_semester=${this.ExamYearSemester}&test_grade=${this.ExamGrade}`)
          .then(res => {
            console.log("FETCH REPORTDETAIL GET RES", res);
            this.StudentId = res.data.StudentId;
            this.StudentName = res.data.StudentName;
            this.ExamYearSemester = res.data.ExamYearSemester;
            this.ExamGrade = res.data.ExamGrade;
            this.ExamResults = res.data.ExamResults;
            this.AnswerList = res.data.AnswerList;
            this.Score = res.data.Score;
            this.StudentRegion = res.data.StudentRegion;
            this.MathAbility = res.data.MathAbility

            this.AnswerList1 = this.AnswerList.slice(0, 14)
            this.AnswerList2 = this.AnswerList.slice(14)

            this.ExamResults1 = this.ExamResults.slice(0, 14)
            this.ExamResults2 = this.ExamResults.slice(14)
            
            // this.radarChartData.datasets[0].data = res.data.MathAbility;
            if (this.radarChartData.datasets && this.radarChartData.datasets.length > 0) {
              this.radarChartData.datasets[0].data[0] = (this.MathAbility[0]*100/28).toFixed(2)
              this.radarChartData.datasets[0].data[1] = (this.MathAbility[1]*100/32).toFixed(2)
              this.radarChartData.datasets[0].data[2] = (this.MathAbility[2]*100/20).toFixed(2)
              this.radarChartData.datasets[0].data[3] = (this.MathAbility[3]*100/20).toFixed(2)
            } else {
              // 적절한 오류 처리 또는 데이터셋 초기화 로직
              console.error('datasets 배열이 초기화되지 않았습니다.');
            }
            console.log("radarChartData : ", this.radarChartData)
            
            const territoryOrder = ["강남서초", "강동송파", "강서양천", "서울남부", "서울동부", "동작관악", "서울북부", "서울서부", "성동광진", "성북강북", "서울중부"];
            const selectedIndex = territoryOrder.indexOf(this.StudentRegion);
            
            this.selectedTerritory_low = parseFloat(res.data.PredPercentile_low[selectedIndex] * 100).toFixed(2);
            this.selectedTerritory_high = parseFloat(res.data.PredPercentile_high[selectedIndex] * 100).toFixed(2);
            
            this.otherTerritories_low = res.data.PredPercentile_low.map((value, index) => ({
              territory: territoryOrder[index],
              value: parseFloat(value * 100).toFixed(2)
            })).filter((_, index) => index !== selectedIndex);
            
            this.otherTerritories_high = res.data.PredPercentile_high.map((value, index) => ({
              territory: territoryOrder[index],
              value: parseFloat(value * 100).toFixed(2)
            })).filter((_, index) => index !== selectedIndex);
            
            this.OX_list = res.data.OX_list;
            this.NationalPredictRatio = (res.data.NationalPredictRatio*100).toFixed(2)
            this.HighSchoolPredictGrade = res.data.HighSchoolPredictGrade;
            this.SuneungPredictGrade = res.data.SuneungPredictGrade
            this.StrongPoint = res.data.StrongPoint;
            console.log("strongPoint : ", this.StrongPoint)
            this.WeakPoint = res.data.WeakPoint;
            console.log("weakPoint : ", this.WeakPoint)
            this.OfficeRegion = territoryOrder.filter(region => region !== this.StudentRegion);
            console.log("office region : ", this.OfficeRegion)
            if (this.carouselPage === 1) {
              this.$nextTick(() => {
                // DOM 업데이트 완료 후 차트 렌더링
                this.renderRadarChart();
              });
            }
          })
          .catch(err => {
            console.log("FETCH STUDENTDETAIL GET ERR.RESPONSE", err.response);
            // alert(`${err.response.status} ${err.response.statusText}`);
          });
      },
      renderRadarChart() {
        this.$nextTick(() => {
          const canvas = document.getElementById('radarChart');
          if (canvas) {
            const ctx = canvas.getContext('2d');
            
            // 기존 차트 인스턴스가 있으면 파괴
            if (this.radarChartInstance) {
              this.radarChartInstance.destroy();
            }
            
            // 새 차트 인스턴스 생성
            this.radarChartInstance = new Chart(ctx, {
              type: 'radar',
              data: this.radarChartData,
              options: {
                scales: {
                  r: {
                    angleLines: {
                      display: true
                    },
                    suggestedMin: Math.min(...this.radarChartData.datasets[0].data)*0.8,
                    suggestedMax: Math.max(...this.radarChartData.datasets[0].data)
                  }
                },
                elements: {
                  line: {
                    borderWidth: 3
                  }
                }
              }
            });
          } else {
            console.error('Canvas element not found');
          }
        });
      },
      renderHorizontalBarChart(index){
        this.$nextTick(() => {

          const canvasId = `horizontalBarChart${index}`;
          const canvas = document.getElementById(canvasId)
//          if (!canvas) {
//          console.error('Canvas element not found for ID:', canvasId);
//            return;
//          }
          if (canvas) {
            if (canvas.offsetWidth === 0 || canvas.offsetHeight === 0) {
              console.error("Canvas size is zero.");
            }

            const ctx = canvas.getContext('2d');

            if (this.horizontalBarChartInstance) {
              this.horizontalBarChartInstance.destroy();
            }

            this.horizonBarChartData.datasets[0].data = [
              parseFloat(this.otherTerritories_low[index].value),
              parseFloat(this.otherTerritories_high[index].value)
            ];

            this.horizontalBarChartInstance = new Chart(ctx, {
              type: 'bar', // 차트 타입을 'bar'로 변경
              data: this.horizonBarChartData,
              options: {
                indexAxis: 'y', // 축을 y로 설정하여 수평 막대 차트 생성
                scales: {
                  x: { // x 축 설정
                    beginAtZero: true, // 0에서 시작
                    suggestedMax: Math.max(...this.horizonBarChartData.datasets[0].data) * 1.2 // 최대값의 1.2배
                  }
                },
                elements: {
                  bar: { // 막대 관련 설정
                    borderWidth: 3
                  }
                }
              }
            });
          } else {
            console.log("in the else...")
            console.error('Canvas element not found');
          }
      });
      },
      range(start, end) {
        const length = end - start + 1;
        return Array.from({ length }, (_, i) => start + i);
      },
      async captureAndDownload() {
        await this.$nextTick(); // Vue의 DOM 업데이트 반영을 위해 대기
        const pdf = new window.jspdf.jsPDF();
        
        // 첫 번째 요소 캡처
        this.carouselPage = 1;
        const element1 = document.getElementById('capture-area1');
        console.log("element1 : ", element1)
        await html2canvas(element1, {
          logging:true,
          useCORS:true
        }).then((canvas) => {
          const imgData1 = canvas.toDataURL('image/png');
          pdf.addImage(imgData1, 'PNG', 0, 0, 210, 297); // 첫 번째 이미지 추가
        }).catch(error => {
          console.log("HTML2CANVAS err : ", error)
        });;

       
        // 두 번째 요소 캡처
        this.carouselPage = 2;
        await this.$nextTick(); // Vue의 DOM 업데이트 반영을 위해 대기
        const element2 = document.getElementById('capture-area2');
        pdf.addPage();
        await html2canvas(element2, {
          logging:true,
          useCORS:true
        }).then((canvas) => {
          const imgData2 = canvas.toDataURL('image/png');
          pdf.addImage(imgData2, 'PNG', 0, 0, 210, 297); // 첫 번째 이미지 추가
        }).catch(error => {
          console.log("HTML2CANVAS err : ", error)
        });

        // 세 번째 요소 캡처
        this.carouselPage = 3;
        await this.$nextTick(); // Vue의 DOM 업데이트 반영을 위해 대기
        const element3 = document.getElementById('capture-area3');
        pdf.addPage();
        await html2canvas(element3, {
          logging:true,
          useCORS:true
        }).then((canvas) => {
          const imgData3 = canvas.toDataURL('image/png');
          pdf.addImage(imgData3, 'PNG', 0, 0, 210, 297); // 첫 번째 이미지 추가
        }).catch(error => {
          console.log("HTML2CANVAS err : ", error)
        });

        const year = this.ExamYearSemester.toString().slice(0, 4);
        let banki
        if (this.ExamYearSemester[-1] == 1) {
          banki = "상반기"
        } else {
          banki = "하반기"
        }
        const pdfName = `${this.StudentName}_${year}년도_${banki}_보고서.pdf`
        
        // PDF 저장
        pdf.save(pdfName);
        
        // 상태 복원
        this.carouselPage = 1;
      },
      carouselPageRight() {
        this.carouselPage += 1;
        if (this.carouselPage == 4) {
          this.carouselPage = 1;
        }
      },
      carouselPageLeft() {
        this.carouselPage -= 1;
        if (this.carouselPage == 0) {
          this.carouselPage = 3;
        }
      },
      carouselControl(pageNumber) {
        this.carouselPage = pageNumber;
      },
      initHorizontalBarCharts() {
        this.OfficeRegion.forEach((_, index) => {
          this.renderHorizontalBarChart(index);
        });
      },
    },

    mounted() {
      this.renderRadarChart()
    },
    unmounted() {
      if (this.carouselPage === 3) {
        this.$nextTick(() => {
          this.initHorizontalBarCharts();
        });
      }
    }
  }
  Vue.createApp(TestSubmitApp).mount('#page-top');
</script>